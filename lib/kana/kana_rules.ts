import { is_kana } from './chars'
import { convert_next, filter_output, m, mFn, RuleContext, rules, RuleSet, transform_rules } from './conversion'
import { tuple } from './util'
import { to_voiced } from './voiced'

// TODO: halfwidth katakana filter

/** Main rule set to convert from any input to katakana. */
export function rules_to_katakana() {
	return rules(
		set_hiragana_to_katakana(),
		set_romaji_to_katakana(),
		set_romaji_double_vowels_as_prolonged_sound_mark(),
	)
}

/** Main rule set to convert from any input to hiragana. */
export function rules_to_hiragana() {
	return rules(set_katakana_to_hiragana(), set_romaji_to_hiragana())
}

/** Rules to convert just the fullwidth characters to ASCII. */
export function rules_fullwidth_ascii() {
	return rules(
		set_punctuation_to_romaji(),
		...map_romaji_fullwidth_ascii((h: string, k: string, r: string) => m(h, r)),
	)
}

/** Main rule set to convert kana to romaji. */
export function rules_to_romaji() {
	const baseOutput = rules(
		set_kana_to_romaji(false),
		set_kana_to_romaji(true),
		set_punctuation_to_romaji(),

		// Weird and rare characters
		m('„Çü', 'yori'),
		m('„Éø', 'KOTO'),

		// Small tsu rule
		mFn('„Å£', (ctx) => small_tsu(ctx, true)),
		mFn('„ÉÉ', (ctx) => small_tsu(ctx, false)),
	)

	function small_tsu(ctx: RuleContext, hiragana: boolean) {
		// Count the number of small tsu following the current one
		const match = ctx.nextInput.match(/^[„Å£„ÉÉ]+/)
		const count = 1 + (match ? match[0].length : 0)
		const [output, length, context] = convert_next(ctx.nextInput.slice(count - 1), ctx.rules)

		// spell-checker: ignore bcdfghjklmnpqrstvwxyz
		const valid = length && /^[bcdfghjklmnpqrstvwxyz]/i.test(output)
		if (valid) {
			const prefix = output[0].repeat(count)
			return tuple(prefix + output, count + length, context.lastOutput)
		}

		if (is_kana(ctx.lastInput)) {
			const prefix = '~'.repeat(count)
			return tuple(prefix, count)
		}

		return tuple('~' + (hiragana ? 'tsu' : 'TSU') + '~'.repeat(count - 1), count)
	}

	// Add a filter that prevents ambiguous n rules to be generated by adding an
	// apostrophe to the output. For example:
	//
	//     `„Å™„Çì„Å™` -> `na` + `n` + `na` -> `na` + `n` + `'na`
	//
	const output = filter_output(baseOutput, (ctx, rule, output) =>
		/^([ny]|[aeiou])/i.test(output) && /n$/i.test(ctx.lastOutput) && !/[Ôº°-Ôº∫]/i.test(ctx.input)
			? `'${output}`
			: output,
	)

	return output
}

//============================================================================//
// Mappers
//============================================================================//

/**
 * Maps any rules that maps an input that ends with a romaji vowel and generates
 * the variants for the long vowels. The variants have the same output, but add
 * a kana long sound mark to it.
 *
 * This only works with simple (non-function) rules.
 */
function map_rules_for_long_vowels(rules: RuleSet) {
	const I = 'aeiouAEIOU'
	const A = '√¢√™√Æ√¥√ª√Ç√ä√é√î√õ'
	const B = 'ƒÅƒìƒ´≈ç≈´ƒÄƒíƒ™≈å≈™'

	const RE_VOWEL = /[aeiou]$/i

	const replace = (input: string, table: string) =>
		input.replace(RE_VOWEL, (key) => {
			const index = I.indexOf(key)
			return table[index]
		})

	return transform_rules(rules, (input) => {
		if (RE_VOWEL.test(input.key) && input.out) {
			return [
				input,
				{ isRuleSet: false, key: replace(input.key, A), out: input.out + '„Éº' },
				{ isRuleSet: false, key: replace(input.key, B), out: input.out + '„Éº' },
			]
		}
		return input
	})
}

//============================================================================//
// Rule sets
//============================================================================//

/** All rules to convert katakana to hiragana. */
function set_katakana_to_hiragana() {
	const ls = [
		// Basic letters
		...map_kana((h, k) => m(k, h)),
		...map_small_kana((h, k) => m(k, h)),

		// Rare and weird characters
		m('„ÉΩ', '„Çù'), // Iteration Mark
		m('„Éæ', '„Çû'), // Voiced Iteration Mark
		m('„Éø', '„Åì„Å®'), // Digraph Koto
		m('ÔΩ∞', '„Éº'), // Halfwidth Katakana-Hiragana Prolonged Sound Mark
		...map_rare_katakana((h, k) => m(k, h)),
	]
	return rules(...ls)
}

/** All rules to convert hiragana to katakana. */
function set_hiragana_to_katakana() {
	const ls = [
		// Basic letters
		...map_kana((h, k) => m(h, k)),
		...map_small_kana((h, k) => m(h, k)),

		// Missing hiragana characters

		// Rare and weird characters
		m('„Çù', '„ÉΩ'), // Iteration Mark
		m('„Çû', '„Éæ'), // Voiced Iteration Mark
		m('„Çü', '„É®„É™'), // Digraph Yori
	]
	return rules(...ls)
}

/** All rules to convert romaji to hiragana. */
function set_romaji_to_hiragana() {
	return set_romaji_to_kana(true)
}

/** All rules to convert romaji to katakana. */
function set_romaji_to_katakana() {
	return set_romaji_to_kana(false)
}

/** Compiles all rules from romaji to hiragana or katakana. */
function set_romaji_to_kana(hiragana: boolean, ime = true) {
	const mapper = (h: string, k: string, r: string) => (hiragana ? m(r, h) : m(r, k))
	const ls = [
		...map_kana(mapper),
		...map_digraphs(mapper), // after map_kana to override archaic characters
		...map_romaji_punctuation(mapper),
	]
	const baseOutput = rules(
		...ls,
		set_romaji_double_consonants(hiragana),
		set_romaji_quoted_long_vowels(hiragana),
		!ime
			? rules()
			: rules(
					...map_romaji_ime(mapper),
					mFn('nn', (ctx) => {
						const out = hiragana ? '„Çì' : '„É≥'
						// At the end of an input, we map 'nn' -> '„Çì' so that
						// typing a double N with IME will generate '„Çì'.
						if (!ctx.nextInput) {
							return tuple(out, 2)
						}
						// Otherwise we map 'n' -> '„Çì', ignoring the 'nn'. We
						// don't want to generate a '„Å£' here because that is
						// the less useful sequence.
						return tuple(out, 1)
					}),
			  ),
	)

	const vowelsOutput = map_rules_for_long_vowels(baseOutput)
	return vowelsOutput
}

/** Conversion for the double consonants using „Å£ or „ÉÉ */
function set_romaji_double_consonants(hiragana: boolean) {
	const CONSONANTS = [
		'b',
		'c',
		'd',
		'f',
		'g',
		'h',
		'j',
		'k',
		// 'l',
		'm',
		// 'n', -- this is overridden in set_romaji_to_kana
		'p',
		'q',
		'r',
		's',
		't',
		'v',
		'w',
		// 'x',
		'y',
		'z',
	]
	const list = CONSONANTS.map((x) => m(x + x, hiragana ? '„Å£' : '„ÉÉ', 1))
	return rules(...list)
}

/** Conversion rules for sequences like "ka'a" to "„Åã„ÅÇ" or "„Ç´„Ç¢" */
function set_romaji_quoted_long_vowels(hiragana: boolean) {
	// Generate the quoted sequence (e.g. `'a` => `„ÅÇ` for the key `a`).
	const q = (key: string, out: string) =>
		mFn(`'${key}`, (ctx) => {
			// Only translate a sequence like `a'a`, this is to avoid messing
			// up random quoted text.
			const last = ctx.lastInput
			if (last && last[last.length - 1].toLowerCase() === key) {
				return tuple(out, 0)
			}
			return tuple('', -1)
		})
	return rules(
		// Generate a quoted rule for each of the vowels
		q('a', hiragana ? '„ÅÇ' : '„Ç¢'),
		q('i', hiragana ? '„ÅÑ' : '„Ç§'),
		q('u', hiragana ? '„ÅÜ' : '„Ç¶'),
		q('e', hiragana ? '„Åà' : '„Ç®'),
		q('o', hiragana ? '„Åä' : '„Ç™'),
	)
}

/**
 * Handle romaji double vowels with a prolonged sound mark (e.g. `aa` => `„Ç¢„Éº`)
 */
function set_romaji_double_vowels_as_prolonged_sound_mark() {
	const q = (key: string, out: string) =>
		mFn(key, (ctx) => {
			const last = ctx.lastInput
			const isLongVowel = last && last[last.length - 1].toLowerCase() === key
			const sameVowelNext = ctx.nextInput.slice(0, 1).toLowerCase() === key
			return tuple(isLongVowel && !sameVowelNext ? '„Éº' : out, 0)
		})
	return rules(
		// generate one rule for each vowel
		q('a', '„Ç¢'),
		q('i', '„Ç§'),
		q('u', '„Ç¶'),
		q('e', '„Ç®'),
		q('o', '„Ç™'),
	)
}

/** Conversion rules for kana to romaji. */
function set_kana_to_romaji(hiragana: boolean) {
	const repeat_marks = (mark: string, voiced: boolean) =>
		mFn(mark, (ctx) => {
			if (is_kana(ctx.lastInput) && /^[a-z]+$/i.test(ctx.lastOutput)) {
				const last = /yori|koto|masu/i.test(ctx.lastOutput) ? ctx.lastOutput.slice(-2) : ctx.lastOutput
				return tuple(voiced ? to_voiced(last) : last, 0, last)
			}
			return tuple('', -1)
		})
	const nc_mapper = hiragana
		? (h: string, k: string, r: string) => m(h, r)
		: (h: string, k: string, r: string) => m(k, r)
	const mapper = hiragana
		? (h: string, k: string, r: string) => m(h, r.toLowerCase())
		: (h: string, k: string, r: string) => m(k, r.toUpperCase())
	const ls = [
		...map_small_kana(mapper),
		...map_kana(mapper),
		...map_digraphs(mapper),
		...map_romaji_fullwidth_ascii(nc_mapper),

		// Additional common digraph combinations for foreign syllables
		m(hiragana ? '„Å¶„ÅÉ' : '„ÉÜ„Ç£', hiragana ? 'ti' : 'TI'),
		m(hiragana ? '„Åß„ÅÉ' : '„Éá„Ç£', hiragana ? 'di' : 'DI'),
		m(hiragana ? '„Å©„ÅÖ' : '„Éâ„Ç•', hiragana ? 'du' : 'DU'),

		//
		// Rare stuff
		//

		...map_rare_katakana(mapper),
		repeat_marks(hiragana ? '„Çù' : '„ÉΩ', false),
		repeat_marks(hiragana ? '„Çû' : '„Éæ', true),
		m('„Äº', hiragana ? 'masu' : 'MASU'),
	]
	return rules(...ls)
}

/** Conversion rules for Japanese punctuation to romaji. */
function set_punctuation_to_romaji() {
	const mapper = (h: string, k: string, r: string) => m(h, r)
	const ls = [
		...map_extra_romaji_punctuation(mapper), // lower precedence than map_romaji_punctuation
		...map_romaji_punctuation(mapper),
	]
	return rules(...ls)
}

//============================================================================//
// Character mappings
//============================================================================//

type MapFn<T> = (hiragana: string, katakana: string, romaji: string, special?: boolean) => T

function map_small_kana<T>(m: MapFn<T>): T[] {
	return [
		m('„ÅÅ', '„Ç°', 'a', true),
		m('„ÅÉ', '„Ç£', 'i', true),
		m('„ÅÖ', '„Ç•', 'u', true),
		m('„Åá', '„Çß', 'e', true),
		m('„Åâ', '„Ç©', 'o', true),
		m('„Å£', '„ÉÉ', 'tsu', true),
		m('„ÇÉ', '„É£', 'ya', true),
		m('„ÇÖ', '„É•', 'yu', true),
		m('„Çá', '„Éß', 'yo', true),
	]
}

/** Katakana only characters that are rarely used. */
function map_rare_katakana<T>(m: MapFn<T>): T[] {
	return [
		// Those are rarely and don't have a corresponding hiragana, so we need
		// to use the combining mark.
		m('„Çè\u{3099}', '„É∑', 'va'),
		m('„Çê\u{3099}', '„É∏', 'vi'),
		m('„Çë\u{3099}', '„Éπ', 've'),
		m('„Çí\u{3099}', '„É∫', 'vo'),

		// Other rare katakana
		m('„Åà', 'õÄÄ', 'e'),

		m('„Åè', '„á∞', 'ku'), // small ku
		m('„Åó', '„á±', 'shi'), // small si
		m('„Åô', '„á≤', 'su'), // small su
		m('„Å®', '„á≥', 'to'), // small to
		m('„Å¨', '„á¥', 'nu'), // small nu
		m('„ÅØ', '„áµ', 'ha'), // small ha
		m('„Å≤', '„á∂', 'hi'), // small hi
		m('„Åµ', '„á∑', 'fu'), // small hu
		m('„Å∏', '„á∏', 'he'), // small he
		m('„Åª', '„áπ', 'ho'), // small ho
		m('„ÇÄ', '„á∫', 'mu'), // small mu
		m('„Çâ', '„áª', 'ra'), // small ra
		m('„Çä', '„áº', 'ri'), // small ri
		m('„Çã', '„áΩ', 'ru'), // small ru
		m('„Çå', '„áæ', 're'), // small re
		m('„Çç', '„áø', 'ro'), // small ro
	]
}

/** All common kana letters, except small digraph letters. */
function map_kana<T>(m: MapFn<T>): T[] {
	return [
		// Those are small but don't participate in any digraph. We need those
		// first to be overridden by later rules (e.g. for romaji)
		m('„Çé', '„ÉÆ', 'wa'),
		m('„Çï', '„Éµ', 'ka'),
		m('„Çñ', '„É∂', 'ka'), // transliterate to romaji as "ka" (https://en.wikipedia.org/wiki/Small_ke)

		// "N" mappings
		m('„Çì', '„É≥', `n'`), // This first so it has lesser precedence
		m('„Çì', '„É≥', 'n'),

		// Non-standard romaji mappings (those must come before so they are
		// overridden when mapping from kana)

		m('„Åã', '„Ç´', 'ca'),
		m('„Åó', '„Ç∑', 'ci'),
		m('„Åè', '„ÇØ', 'cu'),
		m('„Åõ', '„Çª', 'ce'),
		m('„Åì', '„Ç≥', 'co'),

		m('„Åó', '„Ç∑', 'si'),
		m('„Åò', '„Ç∏', 'zi'),

		m('„Å°', '„ÉÅ', 'ti'),
		m('„Å¢', '„ÉÇ', 'dji'),
		m('„Å¢', '„ÉÇ', 'dzi'),

		m('„Å§', '„ÉÑ', 'tu'),
		m('„Å•', '„ÉÖ', 'dzu'),

		m('„Åµ', '„Éï', 'hu'),

		m('„ÅÜ', '„Ç¶', 'wu'),

		// Normal syllables

		m('„ÅÇ', '„Ç¢', 'a'),
		m('„ÅÑ', '„Ç§', 'i'),
		m('„ÅÜ', '„Ç¶', 'u'),
		m('„Åà', '„Ç®', 'e'),
		m('„Åä', '„Ç™', 'o'),
		m('„Åã', '„Ç´', 'ka'),
		m('„Åç', '„Ç≠', 'ki'),
		m('„Åè', '„ÇØ', 'ku'),
		m('„Åë', '„Ç±', 'ke'),
		m('„Åì', '„Ç≥', 'ko'),
		m('„Åå', '„Ç¨', 'ga'),
		m('„Åé', '„ÇÆ', 'gi'),
		m('„Åê', '„Ç∞', 'gu'),
		m('„Åí', '„Ç≤', 'ge'),
		m('„Åî', '„Ç¥', 'go'),
		m('„Åï', '„Çµ', 'sa'),
		m('„Åó', '„Ç∑', 'shi'),
		m('„Åô', '„Çπ', 'su'),
		m('„Åõ', '„Çª', 'se'),
		m('„Åù', '„ÇΩ', 'so'),
		m('„Åñ', '„Ç∂', 'za'),
		m('„Åò', '„Ç∏', 'ji'),
		m('„Åö', '„Ç∫', 'zu'),
		m('„Åú', '„Çº', 'ze'),
		m('„Åû', '„Çæ', 'zo'),
		m('„Åü', '„Çø', 'ta'),
		m('„Å°', '„ÉÅ', 'chi'),
		m('„Å§', '„ÉÑ', 'tsu'),
		m('„Å¶', '„ÉÜ', 'te'),
		m('„Å®', '„Éà', 'to'),
		m('„Å†', '„ÉÄ', 'da'),
		m('„Å¢', '„ÉÇ', 'di'),
		m('„Å•', '„ÉÖ', 'du'),
		m('„Åß', '„Éá', 'de'),
		m('„Å©', '„Éâ', 'do'),
		m('„Å™', '„Éä', 'na'),
		m('„Å´', '„Éã', 'ni'),
		m('„Å¨', '„Éå', 'nu'),
		m('„Å≠', '„Éç', 'ne'),
		m('„ÅÆ', '„Éé', 'no'),
		m('„ÅØ', '„Éè', 'ha'),
		m('„Å≤', '„Éí', 'hi'),
		m('„Åµ', '„Éï', 'fu'),
		m('„Å∏', '„Éò', 'he'),
		m('„Åª', '„Éõ', 'ho'),
		m('„Å∞', '„Éê', 'ba'),
		m('„Å≥', '„Éì', 'bi'),
		m('„Å∂', '„Éñ', 'bu'),
		m('„Åπ', '„Éô', 'be'),
		m('„Åº', '„Éú', 'bo'),
		m('„Å±', '„Éë', 'pa'),
		m('„Å¥', '„Éî', 'pi'),
		m('„Å∑', '„Éó', 'pu'),
		m('„Å∫', '„Éö', 'pe'),
		m('„ÅΩ', '„Éù', 'po'),
		m('„Åæ', '„Éû', 'ma'),
		m('„Åø', '„Éü', 'mi'),
		m('„ÇÄ', '„É†', 'mu'),
		m('„ÇÅ', '„É°', 'me'),
		m('„ÇÇ', '„É¢', 'mo'),
		m('„ÇÑ', '„É§', 'ya'),
		m('„ÇÜ', '„É¶', 'yu'),
		m('„Çà', '„É®', 'yo'),
		m('„Çâ', '„É©', 'ra'),
		m('„Çä', '„É™', 'ri'),
		m('„Çã', '„É´', 'ru'),
		m('„Çå', '„É¨', 're'),
		m('„Çç', '„É≠', 'ro'),
		m('„Çè', '„ÉØ', 'wa'),
		m('„Çê', '„É∞', 'wi'),
		m('„Çë', '„É±', 'we'),
		m('„Çí', '„É≤', 'wo'),
		m('„Çî', '„É¥', 'vu'),
	]
}

/** Map syllables made from combination of kana and small letters */
function map_digraphs<T>(m: MapFn<T>): T[] {
	return [
		// Non-default combinations first, so they are overridden when
		// generating romaji

		m('„Åò„ÇÉ', '„Ç∏„É£', 'jya'),
		m('„Åò„ÇÖ', '„Ç∏„É•', 'jyu'),
		m('„Åò„Åá', '„Ç∏„Çß', 'jye'),
		m('„Åò„Çá', '„Ç∏„Éß', 'jyo'),

		m('„Åò„ÇÉ', '„Ç∏„É£', 'zya'),
		m('„Åò„ÇÖ', '„Ç∏„É•', 'zyu'),
		m('„Åò„Åá', '„Ç∏„Çß', 'zye'),
		m('„Åò„Çá', '„Ç∏„Éß', 'zyo'),

		m('„Å°„ÇÉ', '„ÉÅ„É£', 'tya'),
		m('„Å°„ÇÖ', '„ÉÅ„É•', 'tyu'),
		m('„Å°„Åá', '„ÉÅ„Çß', 'tye'),
		m('„Å°„Çá', '„ÉÅ„Éß', 'tyo'),

		m('„Å¢„ÇÉ', '„ÉÇ„É£', 'dja'),
		m('„Å¢„ÇÖ', '„ÉÇ„É•', 'dju'),
		m('„Å¢„Åá', '„ÉÇ„Çß', 'dje'),
		m('„Å¢„Çá', '„ÉÇ„Éß', 'djo'),

		m('„Å¢„ÇÉ', '„ÉÇ„É£', 'dza'),
		m('„Å¢„Åá', '„ÉÇ„Çß', 'dze'),
		m('„Å¢„Çá', '„ÉÇ„Éß', 'dzo'),

		m('„Åè„ÅÅ', '„ÇØ„Ç°', 'qwa'),
		m('„Åè„ÅÉ', '„ÇØ„Ç£', 'qwi'),
		m('„Åè„Åá', '„ÇØ„Çß', 'qwe'),
		m('„Åè„Åâ', '„ÇØ„Ç©', 'qwo'),

		// Default combinations

		m('„ÅÑ„Åá', '„Ç§„Çß', 'ye'),

		m('„Åç„ÇÉ', '„Ç≠„É£', 'kya'),
		m('„Åç„ÇÖ', '„Ç≠„É•', 'kyu'),
		m('„Åç„Åá', '„Ç≠„Çß', 'kye'),
		m('„Åç„Çá', '„Ç≠„Éß', 'kyo'),

		m('„Åé„ÇÉ', '„ÇÆ„É£', 'gya'),
		m('„Åé„ÇÖ', '„ÇÆ„É•', 'gyu'),
		m('„Åé„Åá', '„ÇÆ„Çß', 'gye'),
		m('„Åé„Çá', '„ÇÆ„Éß', 'gyo'),

		m('„Åè„ÅÅ', '„ÇØ„Ç°', 'qua'),
		m('„Åè„ÅÉ', '„ÇØ„Ç£', 'qui'),
		m('„Åè„Åá', '„ÇØ„Çß', 'que'),
		m('„Åè„Åâ', '„ÇØ„Ç©', 'quo'),

		m('„Åó„ÇÉ', '„Ç∑„É£', 'sha'),
		m('„Åó„ÇÖ', '„Ç∑„É•', 'shu'),
		m('„Åó„Åá', '„Ç∑„Çß', 'she'),
		m('„Åó„Çá', '„Ç∑„Éß', 'sho'),

		m('„Åò„ÇÉ', '„Ç∏„É£', 'ja'),
		m('„Åò„ÇÖ', '„Ç∏„É•', 'ju'),
		m('„Åò„Åá', '„Ç∏„Çß', 'je'),
		m('„Åò„Çá', '„Ç∏„Éß', 'jo'),

		m('„Å°„ÇÉ', '„ÉÅ„É£', 'cha'),
		m('„Å°„ÇÖ', '„ÉÅ„É•', 'chu'),
		m('„Å°„Åá', '„ÉÅ„Çß', 'che'),
		m('„Å°„Çá', '„ÉÅ„Éß', 'cho'),

		m('„Å¢„ÇÉ', '„ÉÇ„É£', 'dya'),
		m('„Å¢„ÇÖ', '„ÉÇ„É•', 'dyu'),
		m('„Å¢„Åá', '„ÉÇ„Çß', 'dye'),
		m('„Å¢„Çá', '„ÉÇ„Éß', 'dyo'),

		m('„Å´„ÇÉ', '„Éã„É£', 'nya'),
		m('„Å´„ÇÖ', '„Éã„É•', 'nyu'),
		m('„Å´„Åá', '„Éã„Çß', 'nye'),
		m('„Å´„Çá', '„Éã„Éß', 'nyo'),

		m('„Å≤„ÇÉ', '„Éí„É£', 'hya'),
		m('„Å≤„ÇÖ', '„Éí„É•', 'hyu'),
		m('„Å≤„Åá', '„Éí„Çß', 'hye'),
		m('„Å≤„Çá', '„Éí„Éß', 'hyo'),

		m('„Å≥„ÇÉ', '„Éì„É£', 'bya'),
		m('„Å≥„ÇÖ', '„Éì„É•', 'byu'),
		m('„Å≥„Åá', '„Éì„Çß', 'bye'),
		m('„Å≥„Çá', '„Éì„Éß', 'byo'),

		m('„Å¥„ÇÉ', '„Éî„É£', 'pya'),
		m('„Å¥„ÇÖ', '„Éî„É•', 'pyu'),
		m('„Å¥„Åá', '„Éî„Çß', 'pye'),
		m('„Å¥„Çá', '„Éî„Éß', 'pyo'),

		m('„Åµ„ÅÅ', '„Éï„Ç°', 'fa'),
		m('„Åµ„ÅÉ', '„Éï„Ç£', 'fi'),
		m('„Åµ„Åá', '„Éï„Çß', 'fe'),
		m('„Åµ„Åâ', '„Éï„Ç©', 'fo'),

		m('„Åø„ÇÉ', '„Éü„É£', 'mya'),
		m('„Åø„ÇÖ', '„Éü„É•', 'myu'),
		m('„Åø„Åá', '„Éü„Çß', 'mye'),
		m('„Åø„Çá', '„Éü„Éß', 'myo'),

		m('„Çä„ÇÉ', '„É™„É£', 'rya'),
		m('„Çä„ÇÖ', '„É™„É•', 'ryu'),
		m('„Çä„Åá', '„É™„Çß', 'rye'),
		m('„Çä„Çá', '„É™„Éß', 'ryo'),

		// Override the archaic and rare characters with combinations

		m('„ÅÜ„ÅÉ', '„Ç¶„Ç£', 'wi'),
		m('„ÅÜ„Åá', '„Ç¶„Çß', 'we'),

		m('„Çî„ÅÅ', '„É¥„Ç°', 'va'),
		m('„Çî„ÅÉ', '„É¥„Ç£', 'vi'),
		m('„Çî„Åá', '„É¥„Çß', 've'),
		m('„Çî„Åâ', '„É¥„Ç©', 'vo'),
	]
}

/** Extra romaji triples for IME input only. */
function map_romaji_ime<T>(m: MapFn<T>): T[] {
	return [
		m('„ÅÅ', '„Ç°', 'xa'),
		m('„ÅÉ', '„Ç£', 'xi'),
		m('„ÅÖ', '„Ç•', 'xu'),
		m('„Åá', '„Çß', 'xe'),
		m('„Åâ', '„Ç©', 'xo'),

		m('„Çê', '„É∞', 'xwi'),
		m('„Çë', '„É±', 'xwe'),

		m('„Çè\u{3099}', '„É∑', 'xva'),
		m('„Çê\u{3099}', '„É∏', 'xvi'),
		m('„Çë\u{3099}', '„Éπ', 'xve'),
		m('„Çí\u{3099}', '„É∫', 'xvo'),

		m('„ÇÉ', '„É£', 'xya'),
		m('„ÇÖ', '„É•', 'xyu'),
		m('„Çá', '„Éß', 'xyo'),

		m('„Å£', '„ÉÉ', 'xtu'),
		m('„Å£', '„ÉÉ', 'xtsu'),

		m('„Å©„ÅÖ', '„Éâ„Ç•', 'xdu'),
		m('„Å¶„ÅÉ', '„ÉÜ„Ç£', 'xti'),
		m('„Åß„ÅÉ', '„Éá„Ç£', 'xdi'),

		m('„Çé', '„ÉÆ', 'xwa'),
		m('„Çï', '„Éµ', 'xka'),
		m('„Çñ', '„É∂', 'xke'),
	]
}

/** The standard romaji punctuation */
function map_romaji_punctuation<T>(mFn: MapFn<T>): T[] {
	const m = (r: string, k: string) => mFn(k, k, r)
	return [
		m(' ', '\u{3000}'),
		m('/', '„Éª'), // Katakana Middle Dot
		m(',', '„ÄÅ'), // Ideographic Comma
		m('.', '„ÄÇ'), // Ideographic Full Stop
		m('[', '„Äå'), // Left Corner Bracket
		m(']', '„Äç'), // Right Corner Bracket
		m('¬´', '„Ää'), // Left Double Angle Bracket
		m('¬ª', '„Äã'), // Right Double Angle Bracket
		m('!', 'ÔºÅ'), // fullwidth exclamation mark
		m('"', 'ÔºÇ'), // fullwidth quotation mark
		m('#', 'ÔºÉ'), // fullwidth number sign
		m('$', 'ÔºÑ'), // fullwidth dollar sign
		m('%', 'ÔºÖ'), // fullwidth percent sign
		m('&', 'ÔºÜ'), // fullwidth ampersand
		m(`'`, 'Ôºá'), // fullwidth apostrophe
		m('(', 'Ôºà'), // fullwidth left parenthesis
		m(')', 'Ôºâ'), // fullwidth right parenthesis
		m('*', 'Ôºä'), // fullwidth asterisk
		m('+', 'Ôºã'), // fullwidth plus sign
		m(':', 'Ôºö'), // fullwidth colon
		m(';', 'Ôºõ'), // fullwidth semicolon
		m('<', 'Ôºú'), // fullwidth less-than sign
		m('=', 'Ôºù'), // fullwidth equals sign
		m('>', 'Ôºû'), // fullwidth greater-than sign
		m('?', 'Ôºü'), // fullwidth question mark
		m('@', 'Ôº†'), // fullwidth commercial at
		m('\\', 'Ôºº'), // fullwidth reverse solidus
		m('^', 'Ôºæ'), // fullwidth circumflex accent
		m('_', 'Ôºø'), // fullwidth low line
		m('`', 'ÔΩÄ'), // fullwidth grave accent
		m('{', 'ÔΩõ'), // fullwidth left curly bracket
		m('|', 'ÔΩú'), // fullwidth vertical line
		m('}', 'ÔΩù'), // fullwidth right curly bracket
		m('~', 'ÔΩû'), // fullwidth tilde

		// Monetary symbols
		m('¬¢', 'Ôø†'),
		m('¬£', 'Ôø°'),
		m('¬¨', 'Ôø¢'),
		m('¬Ø', 'Ôø£'),
		m('¬•', 'Ôø•'),
		m('‚Ç©', 'Ôø¶'),

		// Override the '-' generation from romaji to kana
		m('-', '„Éº'),
	]
}

/**
 * Lower precedence symbols that are never generated from the romaji, but need
 * to be mapped to romaji as well.
 */
function map_extra_romaji_punctuation<T>(mFn: MapFn<T>): T[] {
	const m = (r: string, k: string) => mFn(k, k, r)
	return [
		m('-', 'ÔΩ∞'), // Halfwidth prolonged sound mark
		m('=', '„Ç†'), // Katakana-Hiragana Double Hyphen
		m('<', '„Äà'), // Left Angle Bracket
		m('>', '„Äâ'), // Right Angle Bracket
		m('[', '„Äé'), // Left White Corner Bracket
		m(']', '„Äè'), // Right White Corner Bracket
		m('[', '„Äê'), // Left Black Lenticular Bracket
		m(']', '„Äë'), // Right Black Lenticular Bracket
		m('{', '„Äî'), // Left Tortoise Shell Bracket
		m('}', '„Äï'), // Right Tortoise Shell Bracket
		m('[', '„Äñ'), // Left White Lenticular Bracket
		m(']', '„Äó'), // Right White Lenticular Bracket
		m('{', '„Äò'), // Left White Tortoise Shell Bracket
		m('}', '„Äô'), // Right White Tortoise Shell Bracket
		m('[', '„Äö'), // Left White Square Bracket
		m(']', '„Äõ'), // Right White Square Bracket
		m('~', '„Äú'), // Wave Dash
		m('"', '„Äù'), // Reversed Double Prime Quotation Mark
		m('"', '„Äû'), // Double Prime Quotation Mark
		m('"', '„Äü'), // Low Double Prime Quotation Mark

		// Fullwidth and halfwidth symbols
		m(',', 'Ôºå'), // fullwidth comma
		m('-', 'Ôºç'), // fullwidth hyphen-minus
		m('.', 'Ôºé'), // fullwidth full stop
		m('/', 'Ôºè'), // fullwidth solidus
		m('[', 'Ôºª'), // fullwidth left square bracket
		m(']', 'ÔºΩ'), // fullwidth right square bracket
		m('(', 'ÔΩü'), // fullwidth left white parenthesis
		m(')', 'ÔΩ†'), // fullwidth right white parenthesis

		m('|', 'Ôø§'), // Fullwidth Broken Bar

		m('.', 'ÔΩ°'), // halfwidth ideographic full stop
		m('[', 'ÔΩ¢'), // halfwidth left corner bracket
		m(']', 'ÔΩ£'), // halfwidth right corner bracket
		m(',', 'ÔΩ§'), // halfwidth ideographic comma
		m('/', 'ÔΩ•'), // halfwidth katakana middle dot

		m('|', 'Ôø®'), // halfwidth forms light vertical
		m('‚Üê', 'Ôø©'), // halfwidth leftwards arrow
		m('‚Üë', 'Ôø™'), // halfwidth upwards arrow
		m('‚Üí', 'Ôø´'), // halfwidth rightwards arrow
		m('‚Üì', 'Ôø¨'), // halfwidth downwards arrow
		m('‚ñ†', 'Ôø≠'), // halfwidth black square
		m('‚óã', 'ÔøÆ'), // halfwidth white circle
	]
}

/**
 * Fullwidth ASCII (roman) characters to romaji mappings
 */
function map_romaji_fullwidth_ascii<T>(mFn: MapFn<T>): T[] {
	const m = (r: string, k: string) => mFn(k, k, r)
	return [
		m('0', 'Ôºê'),
		m('1', 'Ôºë'),
		m('2', 'Ôºí'),
		m('3', 'Ôºì'),
		m('4', 'Ôºî'),
		m('5', 'Ôºï'),
		m('6', 'Ôºñ'),
		m('7', 'Ôºó'),
		m('8', 'Ôºò'),
		m('9', 'Ôºô'),
		m('A', 'Ôº°'),
		m('B', 'Ôº¢'),
		m('C', 'Ôº£'),
		m('D', 'Ôº§'),
		m('E', 'Ôº•'),
		m('F', 'Ôº¶'),
		m('G', 'Ôºß'),
		m('H', 'Ôº®'),
		m('I', 'Ôº©'),
		m('J', 'Ôº™'),
		m('K', 'Ôº´'),
		m('L', 'Ôº¨'),
		m('M', 'Ôº≠'),
		m('N', 'ÔºÆ'),
		m('O', 'ÔºØ'),
		m('P', 'Ôº∞'),
		m('Q', 'Ôº±'),
		m('R', 'Ôº≤'),
		m('S', 'Ôº≥'),
		m('T', 'Ôº¥'),
		m('U', 'Ôºµ'),
		m('V', 'Ôº∂'),
		m('W', 'Ôº∑'),
		m('X', 'Ôº∏'),
		m('Y', 'Ôºπ'),
		m('Z', 'Ôº∫'),
		m('a', 'ÔΩÅ'),
		m('b', 'ÔΩÇ'),
		m('c', 'ÔΩÉ'),
		m('d', 'ÔΩÑ'),
		m('e', 'ÔΩÖ'),
		m('f', 'ÔΩÜ'),
		m('g', 'ÔΩá'),
		m('h', 'ÔΩà'),
		m('i', 'ÔΩâ'),
		m('j', 'ÔΩä'),
		m('k', 'ÔΩã'),
		m('l', 'ÔΩå'),
		m('m', 'ÔΩç'),
		m('n', 'ÔΩé'),
		m('o', 'ÔΩè'),
		m('p', 'ÔΩê'),
		m('q', 'ÔΩë'),
		m('r', 'ÔΩí'),
		m('s', 'ÔΩì'),
		m('t', 'ÔΩî'),
		m('u', 'ÔΩï'),
		m('v', 'ÔΩñ'),
		m('w', 'ÔΩó'),
		m('x', 'ÔΩò'),
		m('y', 'ÔΩô'),
		m('z', 'ÔΩö'),
	]
}
